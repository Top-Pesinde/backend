name: ğŸ§ª Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in

env:
  NODE_VERSION: '18'
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres123
  POSTGRES_DB: express_api_test_db

jobs:
  test:
    name: ğŸš€ Run Tests
    runs-on: ubuntu-latest
    
    services:
      # PostgreSQL Database
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      # Redis (isteÄŸe baÄŸlÄ±)
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      


    steps:
      # 1. Checkout Code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3. Install Dependencies
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          echo "âœ… Dependencies installed"

      # 4. Environment Setup
      - name: ğŸŒ Setup Environment Variables
        run: |
          echo "NODE_ENV=test" >> $GITHUB_ENV
          echo "PORT=3001" >> $GITHUB_ENV
          echo "JWT_SECRET=github-actions-test-secret" >> $GITHUB_ENV
          echo "JWT_REFRESH_SECRET=github-actions-refresh-secret" >> $GITHUB_ENV
          echo "DATABASE_URL=postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}?schema=public" >> $GITHUB_ENV
          echo "MAIL_FROM_ADDRESS=test@halisaha.app" >> $GITHUB_ENV
          echo "MAIL_FROM_NAME=HalÄ±saha Test" >> $GITHUB_ENV
          echo "MINIO_ENDPOINT=localhost" >> $GITHUB_ENV
          echo "MINIO_PORT=9000" >> $GITHUB_ENV
          echo "MINIO_USE_SSL=false" >> $GITHUB_ENV
          echo "MINIO_ACCESS_KEY=minioadmin" >> $GITHUB_ENV
          echo "MINIO_SECRET_KEY=minioadmin123" >> $GITHUB_ENV
          echo "âœ… Environment variables set"

      # 5. Database Migration
      - name: ğŸ—„ï¸ Database Setup
        run: |
          echo "ğŸ“‹ Running Prisma generate..."
          npx prisma generate
          
          echo "ğŸ”„ Running database migrations..."
          npx prisma db push --accept-data-loss
          
          echo "âœ… Database setup completed"

             # 6. Start MinIO & Wait for Services  
       - name: â³ Setup MinIO & Wait for Services
         run: |
           echo "ğŸ—„ï¸ Starting MinIO server..."
           docker run -d --name minio-test \
             -p 9000:9000 -p 9001:9001 \
             -e MINIO_ROOT_USER=minioadmin \
             -e MINIO_ROOT_PASSWORD=minioadmin123 \
             minio/minio server /data --console-address ":9001"
           
           echo "ğŸ” Waiting for PostgreSQL..."
           until pg_isready -h localhost -p 5432 -U ${{ env.POSTGRES_USER }}; do
             echo "Waiting for PostgreSQL..."
             sleep 2
           done
           echo "âœ… PostgreSQL ready"
           
           echo "ğŸ” Waiting for Redis..."
           until redis-cli -h localhost -p 6379 ping; do
             echo "Waiting for Redis..."
             sleep 2
           done
           echo "âœ… Redis ready"
           
           echo "ğŸ” Waiting for MinIO..."
           sleep 10
           until curl -f http://localhost:9000/minio/health/live 2>/dev/null; do
             echo "Waiting for MinIO..."
             sleep 3
           done
           echo "âœ… MinIO ready"

      # 7. Build Project
      - name: ğŸ”¨ Build Project
        run: |
          npm run build
          echo "âœ… Project built successfully"

             # 8. Run Tests
       - name: ğŸ§ª Run Tests
         run: |
           echo "ğŸš€ Running all tests..."
           npm run test:ci
           echo "âœ… Tests completed"

             # 9. API Health Check
       - name: ğŸ¥ API Health Check
         run: |
           echo "ğŸš€ Starting server for health check..."
           npm start &
           SERVER_PID=$!
           
           echo "â³ Waiting for server to start..."
           sleep 10
           
           echo "ğŸ” Checking API health..."
           curl -f http://localhost:3001/health || (echo "âŒ Health check failed" && exit 1)
           
           echo "ğŸ›‘ Stopping server..."
           kill $SERVER_PID
           echo "âœ… API health check passed"

       # 10. Forget Password API Test
      - name: ğŸ” Test Forget Password Feature
        run: |
          echo "ğŸš€ Starting server for Forget Password test..."
          npm start &
          SERVER_PID=$!
          
          echo "â³ Waiting for server..."
          sleep 10
          
          echo "ğŸ“§ Testing forgot password endpoint..."
          RESPONSE=$(curl -s -X POST http://localhost:3001/api/v1/auth/forgot-password \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com"}')
          
          echo "ğŸ“ Response: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "âœ… Forgot password test passed"
          else
            echo "âŒ Forgot password test failed"
            kill $SERVER_PID
            exit 1
          fi
          
          echo "ğŸ›‘ Stopping server..."
          kill $SERVER_PID
          echo "âœ… Forget Password feature test completed"

             # 11. Upload Coverage
       - name: ğŸ“Š Upload Coverage to Codecov
         uses: codecov/codecov-action@v3
         with:
           token: ${{ secrets.CODECOV_TOKEN }}
           file: ./coverage/lcov.info
           fail_ci_if_error: false
           verbose: true

       # 12. Upload Test Results
       - name: ğŸ“‹ Upload Test Results
         uses: actions/upload-artifact@v4
         if: always()
         with:
           name: test-results
           path: |
             coverage/
             junit.xml
           retention-days: 30

  # Lint Job (Paralel Ã§alÄ±ÅŸacak)
  lint:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

             - name: ğŸ” Run ESLint
         run: |
           echo "ğŸ” Running ESLint..."
           echo "âš ï¸ ESLint temporarily disabled - will be configured later"

             - name: ğŸ¨ Run Prettier Check
         run: |
           echo "ğŸ¨ Checking code formatting..."
           echo "âš ï¸ Prettier check temporarily disabled - will be configured later"

      - name: ğŸ”’ Run Security Audit
        run: |
          echo "ğŸ”’ Running security audit..."
          npm audit --audit-level high

  # Deploy Job (sadece main branch iÃ§in)
  deploy:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "âœ… Deployment simulation completed"
          # GerÃ§ek deployment komutlarÄ± buraya eklenecek

  # Notification Job
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: always()
    
    steps:
      - name: ğŸ“¢ Send Notification
        run: |
          if [[ "${{ needs.test.result }}" == "success" && "${{ needs.lint.result }}" == "success" ]]; then
            echo "âœ… All tests passed! ğŸ‰"
            echo "ğŸ“§ Sending success notification..."
          else
            echo "âŒ Some tests failed! ğŸ˜"
            echo "ğŸ“§ Sending failure notification..."
          fi 