<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App Test - Read Receipt</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            height: 100vh;
        }

        .container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .user-panel {
            width: 50%;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .user-header {
            padding: 20px;
            background: #075e54;
            color: white;
            text-align: center;
        }

        .login-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .login-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .login-form button {
            padding: 12px;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .login-form button:hover {
            background: #128c7e;
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px 20px;
            background: #f7f7f7;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-items: flex-end;
        }

        .message.received {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: #dcf8c6;
            color: #303030;
        }

        .message.received .message-bubble {
            background: white;
            border: 1px solid #e0e0e0;
            color: #303030;
        }

        .message-info {
            font-size: 11px;
            color: #667781;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message.sent .message-info {
            justify-content: flex-end;
        }

        .read-status {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            font-size: 12px;
        }

        .read-status.sent {
            color: #999;
        }

        .read-status.delivered {
            color: #999;
        }

        .read-status.read {
            color: #34b7f1;
        }

        .message-input-container {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: #f7f7f7;
        }

        .message-input {
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }

        .message-input button {
            padding: 12px 20px;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
        }

        .message-input button:hover {
            background: #128c7e;
        }

        .message-input button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            padding: 10px 20px;
            font-size: 12px;
            color: #666;
            text-align: center;
            background: #f0f0f0;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .conversations-list {
            max-height: 200px;
            overflow-y: auto;
            border-bottom: 1px solid #e0e0e0;
        }

        .conversation-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .conversation-item:hover {
            background: #f5f5f5;
        }

        .conversation-item.active {
            background: #e3f2fd;
        }

        .conversation-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .conversation-last-message {
            font-size: 12px;
            color: #666;
        }

        .unread-count {
            float: right;
            background: #25d366;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .typing-indicator {
            font-size: 12px;
            color: #666;
            font-style: italic;
            padding: 5px 20px;
        }

        .quick-start-btn {
            margin: 10px 20px;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .quick-start-btn:hover {
            background: #0056b3;
        }

        .info-panel {
            padding: 10px 20px;
            background: #e8f4fd;
            border-bottom: 1px solid #bee5eb;
            font-size: 12px;
            color: #0c5460;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sol Panel - Test User 1 -->
        <div class="user-panel" id="user1Panel">
            <div class="user-header">
                <h3>Test User 1 (testuser)</h3>
            </div>

            <div class="info-panel">
                <strong>Test AdÄ±mlarÄ±:</strong><br>
                1. "HÄ±zlÄ± BaÅŸlat" butonuna tÄ±klayÄ±n<br>
                2. Mesaj yazÄ±n ve gÃ¶nderin<br>
                3. DiÄŸer kullanÄ±cÄ±da mesajÄ±n okundu bilgisini kontrol edin
            </div>

            <div class="login-section">
                <div class="login-form">
                    <input type="text" id="username1" placeholder="KullanÄ±cÄ± AdÄ±" value="testuser" readonly>
                    <input type="password" id="password1" placeholder="Åžifre" value="123456" readonly>
                    <button onclick="login(1)">GiriÅŸ Yap</button>
                </div>
                <div class="status" id="status1">BaÄŸlantÄ± Bekleniyor</div>
            </div>

            <button class="quick-start-btn" onclick="quickStart(1)">ðŸš€ HÄ±zlÄ± BaÅŸlat</button>

            <div class="chat-section">
                <div class="chat-header">
                    <span id="chatHeader1">Sohbet SeÃ§in</span>
                </div>

                <div class="conversations-list" id="conversations1">
                    <div style="padding: 20px; text-align: center; color: #666; font-size: 12px;">
                        HenÃ¼z konuÅŸma yok
                    </div>
                </div>

                <div class="typing-indicator" id="typing1" style="display: none;">
                    YazÄ±yor...
                </div>

                <div class="messages-container" id="messages1">
                    <div style="padding: 20px; text-align: center; color: #666; font-size: 12px;">
                        Mesajlar burada gÃ¶rÃ¼necek
                    </div>
                </div>

                <div class="message-input-container">
                    <div class="message-input">
                        <input type="text" id="messageInput1" placeholder="Mesaj yazÄ±n..." disabled>
                        <button onclick="sendMessage(1)" id="sendBtn1" disabled>GÃ¶nder</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SaÄŸ Panel - Test User 2 -->
        <div class="user-panel" id="user2Panel">
            <div class="user-header">
                <h3>Test User 2 (testuser2)</h3>
            </div>

            <div class="info-panel">
                <strong>Read Receipt Test:</strong><br>
                1. Sol taraftan mesaj geldiÄŸinde<br>
                2. Otomatik olarak "okundu" olarak iÅŸaretlenecek<br>
                3. Sol tarafta âœ“âœ“ mavi tik gÃ¶receksiniz
            </div>

            <div class="login-section">
                <div class="login-form">
                    <input type="text" id="username2" placeholder="KullanÄ±cÄ± AdÄ±" value="testuser2" readonly>
                    <input type="password" id="password2" placeholder="Åžifre" value="123456" readonly>
                    <button onclick="login(2)">GiriÅŸ Yap</button>
                </div>
                <div class="status" id="status2">BaÄŸlantÄ± Bekleniyor</div>
            </div>

            <button class="quick-start-btn" onclick="quickStart(2)">ðŸš€ HÄ±zlÄ± BaÅŸlat</button>

            <div class="chat-section">
                <div class="chat-header">
                    <span id="chatHeader2">Sohbet SeÃ§in</span>
                </div>

                <div class="conversations-list" id="conversations2">
                    <div style="padding: 20px; text-align: center; color: #666; font-size: 12px;">
                        HenÃ¼z konuÅŸma yok
                    </div>
                </div>

                <div class="typing-indicator" id="typing2" style="display: none;">
                    YazÄ±yor...
                </div>

                <div class="messages-container" id="messages2">
                    <div style="padding: 20px; text-align: center; color: #666; font-size: 12px;">
                        Mesajlar burada gÃ¶rÃ¼necek
                    </div>
                </div>

                <div class="message-input-container">
                    <div class="message-input">
                        <input type="text" id="messageInput2" placeholder="Mesaj yazÄ±n..." disabled>
                        <button onclick="sendMessage(2)" id="sendBtn2" disabled>GÃ¶nder</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // API Base URL - backend sunucunuzun adresini buraya yazÄ±n
        const API_BASE_URL = 'http://localhost:3000/api/v1';
        const SOCKET_URL = 'http://localhost:3000';

        // Test kullanÄ±cÄ±larÄ± ID'leri (create-test-users.js'den gelen)
        const TEST_USER_IDS = {
            'testuser': 'cmd0kp5p500009d1w3k7gbigv',
            'testuser2': 'cmd0lx8i700059d1wfzsnssvn'
        };

        // User states
        const userStates = {
            1: {
                token: null,
                userId: null,
                socket: null,
                currentConversationId: null,
                conversations: [],
                otherUserData: null,
                typingTimer: null,
                isTyping: false
            },
            2: {
                token: null,
                userId: null,
                socket: null,
                currentConversationId: null,
                conversations: [],
                otherUserData: null,
                typingTimer: null,
                isTyping: false
            }
        };

        // Quick start function
        async function quickStart(userNum) {
            updateStatus(userNum, 'HÄ±zlÄ± baÅŸlatÄ±lÄ±yor...', 'connected');

            await login(userNum);

            // 2 saniye bekle sonra otomatik konuÅŸma baÅŸlat
            setTimeout(async () => {
                if (userStates[userNum].token) {
                    if (userNum === 1) {
                        await startConversationWithTestUser(userNum, 'testuser2');
                    } else {
                        await startConversationWithTestUser(userNum, 'testuser');
                    }
                }
            }, 2000);
        }

        // Start conversation with test user
        async function startConversationWithTestUser(userNum, targetUsername) {
            try {
                const targetUserId = TEST_USER_IDS[targetUsername];
                if (targetUserId) {
                    updateStatus(userNum, 'KonuÅŸma baÅŸlatÄ±lÄ±yor...', 'connected');
                    await startConversation(userNum, targetUserId);
                    updateStatus(userNum, 'HazÄ±r! Mesaj gÃ¶nderebilirsiniz âœ“', 'connected');
                }
            } catch (error) {
                console.error('Start conversation with test user error:', error);
                updateStatus(userNum, 'KonuÅŸma baÅŸlatma hatasÄ±', 'disconnected');
            }
        }

        // Login function
        async function login(userNum) {
            const username = document.getElementById(`username${userNum}`).value;
            const password = document.getElementById(`password${userNum}`).value;

            try {
                updateStatus(userNum, 'GiriÅŸ yapÄ±lÄ±yor...', 'connected');

                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password
                    })
                });

                const data = await response.json();

                if (data.success) {
                    userStates[userNum].token = data.data.accessToken;
                    userStates[userNum].userId = data.data.user.id;

                    updateStatus(userNum, 'Socket baÄŸlanÄ±yor...', 'connected');

                    // Socket baÄŸlantÄ±sÄ± kur
                    await connectSocket(userNum);

                    // KonuÅŸmalarÄ± yÃ¼kle
                    await loadConversations(userNum);

                    // Input'larÄ± aktif et
                    const messageInput = document.getElementById(`messageInput${userNum}`);
                    messageInput.disabled = false;
                    messageInput.addEventListener('input', () => handleTyping(userNum));
                    document.getElementById(`sendBtn${userNum}`).disabled = false;

                    updateStatus(userNum, 'BaÄŸlandÄ± âœ“', 'connected');

                } else {
                    updateStatus(userNum, `Hata: ${data.message}`, 'disconnected');
                }
            } catch (error) {
                console.error('Login error:', error);
                updateStatus(userNum, 'BaÄŸlantÄ± hatasÄ±', 'disconnected');
            }
        }

        // Socket connection
        async function connectSocket(userNum) {
            return new Promise((resolve) => {
                const socket = io(SOCKET_URL, {
                    auth: {
                        token: userStates[userNum].token
                    },
                    transports: ['websocket', 'polling']
                });

                userStates[userNum].socket = socket;

                socket.on('connected', (data) => {
                    console.log(`User ${userNum} socket connected:`, data);
                    resolve();
                });

                socket.on('new_chat_message', (data) => {
                    console.log(`User ${userNum} received message:`, data);
                    displayMessage(userNum, data.message, 'received');

                    // Otomatik olarak mesajlarÄ± okundu iÅŸaretle (gerÃ§ek zamanlÄ± test iÃ§in)
                    if (userStates[userNum].currentConversationId === data.message.conversationId) {
                        setTimeout(() => {
                            markMessagesAsRead(userNum, data.message.conversationId);
                        }, 1500); // 1.5 saniye sonra okundu iÅŸaretle
                    }
                });

                socket.on('message_sent', (data) => {
                    console.log(`User ${userNum} message sent:`, data);
                    if (data.success) {
                        displayMessage(userNum, data.message, 'sent');
                    }
                });

                socket.on('messages_read_by_user', (data) => {
                    console.log(`User ${userNum} messages read by:`, data);
                    updateReadReceipts(userNum, data.userId);
                });

                socket.on('user_typing_start', (data) => {
                    console.log(`User ${userNum} typing start:`, data);
                    if (data.conversationId === userStates[userNum].currentConversationId) {
                        const typingIndicator = document.getElementById(`typing${userNum}`);
                        typingIndicator.style.display = 'block';
                    }
                });

                socket.on('user_typing_stop', (data) => {
                    console.log(`User ${userNum} typing stop:`, data);
                    if (data.conversationId === userStates[userNum].currentConversationId) {
                        const typingIndicator = document.getElementById(`typing${userNum}`);
                        typingIndicator.style.display = 'none';
                    }
                });

                socket.on('conversation_joined', (data) => {
                    console.log(`User ${userNum} joined conversation:`, data);
                });

                socket.on('chat_error', (data) => {
                    console.error(`User ${userNum} chat error:`, data);
                    updateStatus(userNum, `Chat HatasÄ±: ${data.message}`, 'disconnected');
                });

                socket.on('disconnect', () => {
                    updateStatus(userNum, 'BaÄŸlantÄ± kesildi', 'disconnected');
                });

                socket.on('connect_error', (error) => {
                    console.error(`User ${userNum} connection error:`, error);
                    updateStatus(userNum, 'BaÄŸlantÄ± hatasÄ±', 'disconnected');
                });
            });
        }

        // Load conversations
        async function loadConversations(userNum) {
            try {
                const response = await fetch(`${API_BASE_URL}/chat/conversations`, {
                    headers: {
                        'Authorization': `Bearer ${userStates[userNum].token}`
                    }
                });

                const data = await response.json();

                if (data.success && data.data && data.data.length > 0) {
                    userStates[userNum].conversations = data.data;
                    displayConversations(userNum);
                }
            } catch (error) {
                console.error('Load conversations error:', error);
            }
        }

        // Display conversations
        function displayConversations(userNum) {
            const container = document.getElementById(`conversations${userNum}`);
            container.innerHTML = '';

            userStates[userNum].conversations.forEach(conversation => {
                const otherUser = conversation.user1.id === userStates[userNum].userId ?
                    conversation.user2 :
                    conversation.user1;

                const div = document.createElement('div');
                div.className = 'conversation-item';
                div.onclick = () => selectConversation(userNum, conversation.id, otherUser);

                div.innerHTML = `
                    <div class="conversation-name">
                        ${otherUser.firstName} ${otherUser.lastName} (@${otherUser.username})
                    </div>
                    <div class="conversation-last-message">
                        ${conversation.lastMessage || 'HenÃ¼z mesaj yok'}
                    </div>
                    ${conversation.unreadCount > 0 ? `<div class="unread-count">${conversation.unreadCount}</div>` : ''}
                `;

                container.appendChild(div);
            });
        }

        // Start conversation
        async function startConversation(userNum, otherUserId) {
            try {
                const response = await fetch(`${API_BASE_URL}/chat/conversations/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userStates[userNum].token}`
                    },
                    body: JSON.stringify({
                        otherUserId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const conversation = data.data;
                    userStates[userNum].currentConversationId = conversation.id;

                    const otherUser = conversation.user1.id === userStates[userNum].userId ?
                        conversation.user2 :
                        conversation.user1;

                    userStates[userNum].otherUserData = otherUser;

                    await selectConversation(userNum, conversation.id, otherUser);

                    // Reload conversations
                    await loadConversations(userNum);
                }
            } catch (error) {
                console.error('Start conversation error:', error);
            }
        }

        // Select conversation
        async function selectConversation(userNum, conversationId, otherUser) {
            userStates[userNum].currentConversationId = conversationId;
            userStates[userNum].otherUserData = otherUser;

            document.getElementById(`chatHeader${userNum}`).textContent =
                `${otherUser.firstName} ${otherUser.lastName}`;

            // Join conversation room
            userStates[userNum].socket.emit('join_conversation', {
                conversationId
            });

            // Load messages
            await loadMessages(userNum, conversationId);

            // Mark messages as read
            await markMessagesAsRead(userNum, conversationId);

            // Update active conversation in UI
            document.querySelectorAll(`#conversations${userNum} .conversation-item`).forEach(item => {
                item.classList.remove('active');
            });
        }

        // Load messages
        async function loadMessages(userNum, conversationId) {
            try {
                const response = await fetch(`${API_BASE_URL}/chat/conversations/${conversationId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${userStates[userNum].token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById(`messages${userNum}`);
                    container.innerHTML = '';

                    if (data.data.messages && data.data.messages.length > 0) {
                        data.data.messages.forEach(message => {
                            const messageType = message.senderId === userStates[userNum].userId ? 'sent' : 'received';
                            displayMessage(userNum, message, messageType, false);
                        });
                    } else {
                        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666; font-size: 12px;">HenÃ¼z mesaj yok. Ä°lk mesajÄ± gÃ¶nderin!</div>';
                    }

                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                console.error('Load messages error:', error);
            }
        }

        // Display message
        function displayMessage(userNum, message, type, isNew = true) {
            const container = document.getElementById(`messages${userNum}`);

            // Ä°lk mesaj ise placeholder'Ä± temizle
            if (container.innerHTML.includes('HenÃ¼z mesaj yok') || container.innerHTML.includes('Mesajlar burada gÃ¶rÃ¼necek')) {
                container.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.setAttribute('data-message-id', message.id);

            const time = new Date(message.createdAt).toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            let readStatus = '';
            if (type === 'sent') {
                if (message.isRead) {
                    readStatus = '<span class="read-status read">âœ“âœ“ Okundu</span>';
                } else {
                    readStatus = '<span class="read-status delivered">âœ“âœ“ Ä°letildi</span>';
                }
            }

            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${message.content}
                </div>
                <div class="message-info">
                    <span>${time}</span>
                    ${readStatus}
                </div>
            `;

            container.appendChild(messageDiv);

            if (isNew) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // Send message
        async function sendMessage(userNum) {
            const input = document.getElementById(`messageInput${userNum}`);
            const content = input.value.trim();

            if (!content || !userStates[userNum].currentConversationId || !userStates[userNum].otherUserData) {
                return;
            }

            const otherUserId = userStates[userNum].otherUserData.id;

            userStates[userNum].socket.emit('send_chat_message', {
                receiverId: otherUserId,
                content: content,
                messageType: 'TEXT'
            });

            input.value = '';
            handleTypingStop(userNum);
        }

        // Mark messages as read
        async function markMessagesAsRead(userNum, conversationId) {
            try {
                userStates[userNum].socket.emit('mark_messages_read', {
                    conversationId
                });
            } catch (error) {
                console.error('Mark messages as read error:', error);
            }
        }

        // Update read receipts
        function updateReadReceipts(userNum, readByUserId) {
            console.log(`Updating read receipts for user ${userNum}, read by ${readByUserId}`);

            const sentMessages = document.querySelectorAll(`#messages${userNum} .message.sent`);

            sentMessages.forEach(messageDiv => {
                const readStatusSpan = messageDiv.querySelector('.read-status');
                if (readStatusSpan && !readStatusSpan.classList.contains('read')) {
                    readStatusSpan.textContent = 'âœ“âœ“ Okundu';
                    readStatusSpan.className = 'read-status read';
                    console.log('Read receipt updated for message');
                }
            });
        }

        function handleTyping(userNum) {
            const user = userStates[userNum];
            if (!user.isTyping) {
                user.isTyping = true;
                user.socket.emit('typing_start', {
                    conversationId: user.currentConversationId,
                    receiverId: user.otherUserData.id
                });
            }
            if (user.typingTimer) clearTimeout(user.typingTimer);
            user.typingTimer = setTimeout(() => {
                handleTypingStop(userNum);
            }, 2000);
        }

        function handleTypingStop(userNum) {
            const user = userStates[userNum];
            if (user.isTyping) {
                user.isTyping = false;
                user.socket.emit('typing_stop', {
                    conversationId: user.currentConversationId,
                    receiverId: user.otherUserData.id
                });
            }
        }

        // Update status
        function updateStatus(userNum, message, type) {
            const statusElement = document.getElementById(`status${userNum}`);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        // Enter key support
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (e.target.id === 'messageInput1') {
                    sendMessage(1);
                } else if (e.target.id === 'messageInput2') {
                    sendMessage(2);
                }
            }
        });

        // Page load message
        console.log('Chat Read Receipt Test SayfasÄ± YÃ¼klendi');
        console.log('Test KullanÄ±cÄ±larÄ±:');
        console.log('1. testuser / 123456');
        console.log('2. testuser2 / 123456');
        console.log('');
        console.log('Test AdÄ±mlarÄ±:');
        console.log('1. Her iki tarafta da "HÄ±zlÄ± BaÅŸlat" butonuna tÄ±klayÄ±n');
        console.log('2. Bir taraftan mesaj gÃ¶nderin');
        console.log('3. DiÄŸer tarafta mesajÄ±n geldiÄŸini ve otomatik okundu iÅŸaretlendiÄŸini kontrol edin');
        console.log('4. Ä°lk tarafta âœ“âœ“ iÅŸaretinin mavi renge dÃ¶ndÃ¼ÄŸÃ¼nÃ¼ kontrol edin');
    </script>
</body>

</html>